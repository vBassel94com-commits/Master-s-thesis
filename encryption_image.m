%???????? ???????
%  poolobj = parpool(2);
global rows colum FILE cipher_image I flag  cipher_image1
flag=255;
[file,path] = uigetfile({'*.jpg', 'File Selector'});
if file ==0
    return;
end
%a= imread('A.ico');
FILE=strcat(path,file);
a=imread(strcat(path,file));
%????? ?????? 
 [s_box, inv_s_box, w, poly_mat, inv_poly_mat] = aes_init;
%????? ?????? ??? ?????
I = rgb2gray(a);
[rows,colum]=size(I);
c=dec2hex(I);
% L_image=length(c);
c=num2cell(c,2);
c=c';
d=c(1:16);
z=d(1:16);
plaintext_hex = z;
plaintext = hex2dec (plaintext_hex);
ciphertext = cipher (plaintext, w, s_box, poly_mat, 1);
d1=ciphertext;
% 
 LENC=length(c);

R=mod(length(c),16);
r=16-R;
if R~=0

c(length(c)+1:length(c)+r)={'0'};
end

parfor i=1:(length(c)/16-1)
%[s_box, inv_s_box, w, poly_mat, inv_poly_mat] = aes_init;
a=1+(i*16);
b=16+(i*16);

d=c(a:b);
z=d(1:16);
plaintext_hex = z;
plaintext = hex2dec (plaintext_hex);
ciphertext = cipher (plaintext, w, s_box, poly_mat, 1);
d1=[d1 ciphertext];
end
%  d1 ??? ???? ??? ????? ????  
% ??? ??????? ?? ???? ????
% ???? ?????? ?????? ??????? 


cipher_image1=d1;

 if R~=0
d1(LENC+r:-1:LENC+1)=[];
 end

cipher_image=reshape(d1,rows,colum);
%????? ?????? ?? 8 ?? 
cipher_image=uint8(cipher_image);
%??? ?????? ???????
% figure(1)
%  imshow(cipher_image)
%  figure(2)
%  
%   imshow(I)
  colum=uint32(colum);
  rows=uint32(rows);
 
%???? ???? ?????? ??? ???????? ???????? ? ???????? ??????? 
clear a c ciphertext d  z plaintext_hex plaintext ciphertext i I w s_box poly_mat d1 R r count  LENC path file 
clear inv_poly_mat  inv_s_box 
